<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>London Trip Booking</title>
    <link rel="stylesheet" href="../styles/booking.css">
       <link
    href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    rel="stylesheet"/>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <!-- title (from backend) -->
      <h1></h1>
    </div>

    <div class="content">
      <!-- Left Booking Card -->
      <div class="booking-card">
        <img alt="Destination preview" />
      </div>

      <!-- Right Hero Image -->
      <div class="hero">
        <img alt="Destination hero" />
        <!-- Right side -->
        <div class="right">

          <div class="options">
            <!-- Price per night -->
            <div class="option selected" style="margin-top: 30px;">
              Price per night <span></span>
            </div>
          </div>

          <div class="overview">
            <h3>OVERVIEW</h3>
            <p></p>
          </div>

          <div class="booking-form">
            <h3>Booking details</h3>
            <form id="bookingForm" class="form-grid">
              <div class="form-group">
                <label for="persons">Number of persons</label>
                <input id="persons" type="number" name="persons" min="1" value="1" required>
              </div>

              <div class="form-group">
                <label for="nights">Number of nights</label>
                <input id="nights" type="number" name="nights" min="1" value="1" required>
              </div>

              <button type="submit" class="btn-primary">Confirm Booking</button>
            </form>
            <p id="bookingMsg"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>  
  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    console.log('Received ID:', id);

    let destination = {}; // global

    function formatEGP(amount) {
      try {
        return 'LE ' + Number(amount).toLocaleString('en-EG', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' EGP';
      } catch {
        return `LE ${amount} EGP`;
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const { data } = await axios.get(`http://localhost:2005/api/v1/destinations/${id}`);
        destination = data.destination;
        console.log('Fetched destination:', destination);

        // Title
        const titleEl = document.querySelector('.header h1');
        if (titleEl) titleEl.textContent = destination.title || "Unknown Destination";

        // Left booking card image
        const leftImg = document.querySelector('.booking-card img');
        if (leftImg && destination.imgs?.[0]) {
          leftImg.src = destination.imgs[0];
          leftImg.alt = destination.title;
        }

        // Right hero image
        const heroImg = document.querySelector('.hero img');
        if (heroImg) {
          const src = destination.imgs?.[1] || destination.imgs?.[0];
          if (src) {
            heroImg.src = src;
            heroImg.alt = destination.title + ' - hero';
          }
        }

        // Price per night
        const priceSpan = document.querySelector('.right .options .option.selected span');
        if (priceSpan) priceSpan.textContent = formatEGP(destination.pricePerNight);

        // Overview
        const overviewP = document.querySelector('.overview p');
        if (overviewP) overviewP.textContent = destination.desc || "No description available";

      } catch (err) {
        console.error("Error fetching destination:", err);
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('bookingForm');
      const msg = document.getElementById('bookingMsg');

      form.addEventListener('submit', (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const name = String(formData.get('name')).trim();
        const persons = Number(formData.get('persons'));
        const nights = Number(formData.get('nights'));

        if (!name || persons <= 0 || nights <= 0) {
          msg.textContent = 'Please fill all fields correctly.';
          msg.style.color = 'crimson';
          return;
        }

        // ✅ Calculate total price using backend data
        const totalPrice = destination.pricePerNight * persons * nights;

        // Create new booking object
        const newBooking = {
          destination: destination._id,
          date: Date.now(),
          details: 
            { persons, nights, totalPrice }
        };

        axios.post("http://localhost:2005/api/v1/bookings/add",newBooking).then(res=>{
            console.log(res);
        })
        Swal.fire({
        title: '✅ Booking Successful!',
        html: `
            <p>You booked a trip to <b>${destination.title}</b></p>
            <p>Total Price: <b>LE ${totalPrice.toLocaleString()}</b></p>
        `,
        icon: 'success',
        confirmButtonText: 'Awesome!'
        });
       
        form.reset();

      });
    });
  </script>
</body>
</body>

</html>